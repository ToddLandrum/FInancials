*--------------------------------------------------------------------------------------------------------------------------------------------------------
* (ES) AUTOGENERADO - ¡¡ATENCIÓN!! - ¡¡NO PENSADO PARA EJECUTAR!! USAR SOLAMENTE PARA INTEGRAR CAMBIOS Y ALMACENAR CON HERRAMIENTAS SCM!!
* (EN) AUTOGENERATED - ATTENTION!! - NOT INTENDED FOR EXECUTION!! USE ONLY FOR MERGING CHANGES AND STORING WITH SCM TOOLS!!
*--------------------------------------------------------------------------------------------------------------------------------------------------------
*< FOXBIN2PRG: Version="1.19" SourceFile="utsupportemail.scx" /> (Solo para binarios VFP 9 / Only for VFP 9 binaries)
*
*
DEFINE CLASS dataenvironment AS dataenvironment 
 	*< CLASSDATA: Baseclass="dataenvironment" Timestamp="" Scale="" Uniqueid="" ClassIcon="1" />

	AutoOpenTables = .F.
	DataSource = .NULL.
	Height = 200
	Left = 42
	Name = "Dataenvironment"
	Top = 483
	Width = 520

ENDDEFINE

DEFINE CLASS formutsupportemail AS frmformcustom OF "..\custom\cforms.vcx" 
 	*< CLASSDATA: Baseclass="form" Timestamp="" Scale="" Uniqueid="" />

	*-- OBJECTDATA items order determines ZOrder / El orden de los items OBJECTDATA determina el ZOrder 
	*< OBJECTDATA: ObjPath="txtcEmail" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Lbllabelcustom1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Cmdcommandbuttoncustom1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Cmdcommandbuttoncustom2" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="edtBody" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Lbllabelcustom3" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="edtSupportInfo" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Lbllabelcustom2" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="txtCCEmail" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Lbllabelcustom4" UniqueID="" Timestamp="" />

	*<DefinedPropArrayMethod>
		*m: sendemail		&& Sends the email msg to support@sherware.com
		*p: cmessage
		*p: cmethod
		*p: nerror
	*</DefinedPropArrayMethod>

	Caption = "Report Error To Support"
	cmessage = .F.
	cmethod = .F.
	DoCreate = .T.
	Height = 456
	Name = "FormUTSupportEmail"
	nerror = .F.
	Width = 488

	ADD OBJECT 'Cmdcommandbuttoncustom1' AS cmdcommandbuttoncustom WITH ;
		Caption = "\<Send", ;
		Left = 156, ;
		Name = "Cmdcommandbuttoncustom1", ;
		TabIndex = 6, ;
		Top = 424
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="commandbutton" />

	ADD OBJECT 'Cmdcommandbuttoncustom2' AS cmdcommandbuttoncustom WITH ;
		Caption = "\<Cancel", ;
		Left = 252, ;
		Name = "Cmdcommandbuttoncustom2", ;
		TabIndex = 7, ;
		Top = 424
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="commandbutton" />

	ADD OBJECT 'edtBody' AS edteditboxcustom WITH ;
		Height = 106, ;
		Left = 24, ;
		Name = "edtBody", ;
		TabIndex = 4, ;
		Top = 119, ;
		Width = 444
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="editbox" />

	ADD OBJECT 'edtSupportInfo' AS edteditboxcustom WITH ;
		Enabled = .F., ;
		Height = 106, ;
		Left = 24, ;
		Name = "edtSupportInfo", ;
		TabIndex = 5, ;
		Top = 275, ;
		Width = 444
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="editbox" />

	ADD OBJECT 'Lbllabelcustom1' AS lbllabelcustom WITH ;
		Caption = "From:", ;
		Left = 49, ;
		Name = "Lbllabelcustom1", ;
		TabIndex = 3, ;
		Top = 13
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="label" />

	ADD OBJECT 'Lbllabelcustom2' AS lbllabelcustom WITH ;
		Caption = "Additional Information Being Sent To Support:", ;
		FontBold = .T., ;
		Left = 25, ;
		Name = "Lbllabelcustom2", ;
		TabIndex = 9, ;
		Top = 256
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="label" />

	ADD OBJECT 'Lbllabelcustom3' AS lbllabelcustom WITH ;
		Caption = "Describe what you were doing when this error occurrred:", ;
		FontBold = .T., ;
		Left = 25, ;
		Name = "Lbllabelcustom3", ;
		TabIndex = 8, ;
		Top = 101
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="label" />

	ADD OBJECT 'Lbllabelcustom4' AS lbllabelcustom WITH ;
		Caption = "CC:", ;
		Left = 59, ;
		Name = "Lbllabelcustom4", ;
		TabIndex = 10, ;
		Top = 37
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="label" />

	ADD OBJECT 'txtCCEmail' AS txttextboxcustom WITH ;
		Height = 20, ;
		Left = 84, ;
		Name = "txtCCEmail", ;
		TabIndex = 2, ;
		Top = 36, ;
		Width = 388
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="textbox" />

	ADD OBJECT 'txtcEmail' AS txttextboxcustom WITH ;
		Height = 20, ;
		Left = 84, ;
		Name = "txtcEmail", ;
		TabIndex = 1, ;
		Top = 12, ;
		Width = 388
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="textbox" />
	
	PROCEDURE Init
		LPARAMETERS tnError, tcMethod, tcMessage
		
		thisform.edtsupportInfo.Value = 'Error:   ' + TRANSFORM(tnError) + CHR(10) + ;
		                                'Method:  ' + tcMethod + CHR(10) + ;
		                                'Desc:    ' + tcMessage + CHR(10)
		
		thisform.nerror = tnError
		thisform.cmethod = tcMethod
		                                
		DODEFAULT()                     
	ENDPROC

	PROCEDURE sendemail		&& Sends the email msg to support@sherware.com
		LOCAL lcSender, lcMailServer, lcSenderName, llDirectDepOnly
		
		* If wwipstuff.dll doesn't exist on the pc, tell them to send an email themselves
		IF NOT FILE('wwipstuff.dll')
		   THISFORM.omessage.DISPLAY('Missing critical file for sending email. Please contact SherWare support.')
		   RETURN
		ENDIF
		
		lcClient  = m.goApp.cClient
		lcCompany = m.goApp.cRegCompany
		lcRegCode = m.goApp.cCode
		lcVersion = m.goApp.cFileVersion
		lcDate    = DTOC(FDATE(ALLTRIM(m.goApp.cexecutable)))
		lcTime    = FTIME(ALLTRIM(m.goApp.cexecutable))
		lcSender  = THISFORM.txtcEmail.VALUE
		lcCC      = THISFORM.txtccEmail.VALUE
		lcSubject = 'Error: ' + TRANSFORM(thisform.nerror) + ' in ' + thisform.cmethod
		lcBody    = 'Client:  ' + lcClient + CHR(10) + ;
		   'Company:  ' + lcCompany + CHR(10) + ;
		   'Software: ' + ALLTRIM(UPPER(m.goapp.cexecutable)) + CHR(10) + ;
		   'RegCode:  ' + lcRegCode + CHR(10) + ;
		   'Version:  ' + lcVersion + ' Date: ' + lcDate + ' Time: ' + lcTime + CHR(10) + chr(10) + ;
		   ALLTRIM(THISFORM.edtBody.VALUE) + SPACE(5) + CHR(10) + ;
		   ALLTRIM(thisform.edtSupportInfo.Value)
		IF NOT '@' $ lcSender
		   THISFORM.omessage.DISPLAY('Invalid company email address. Cannot send email.')
		   RETURN
		ENDIF
		
		*  Here, we'll send an email automatically to let us know the backup is there
		SET MEMOWIDTH TO 8192
		
		oSendMail = CREATEOBJECT('swSendMail')
		
		swselect('options')
		*** Sending SMTP Mail
		oSendMail.lOutlook      = options.lUseOutlook
		oSendMail.cEMailServer  = options.cemailserver
		oSendMail.cEmailAddress = ALLT(lcSender)
		oSendMail.cSenderName   = ALLT(lcCompany)
		oSendMail.cCC           = ALLTRIM(lcCC)
		oSendMail.cTo           = 'supporttrk@sherware.com'
		oSendMail.cBCC          = ""
		oSendMail.cSubject      = lcSubject
		oSendMail.cBody         = lcBody
		
		WAIT WIND NOWAIT "Sending Email To SherWare Support"
		llResult = oSendMail.SendMail()       && Send again - wait for completion
		
		IF !llResult
		   THISFORM.omessage.warning('Unable to Send Email. Try Again Later.')
		ELSE
		   THISFORM.omessage.warning('Message Sent.')
		   thisform.Release()
		ENDIF
		
		RETURN
		
	ENDPROC

	PROCEDURE Cmdcommandbuttoncustom1.Click
		thisform.sendemail()
	ENDPROC

	PROCEDURE Cmdcommandbuttoncustom2.Click
		thisform.Release()
	ENDPROC

ENDDEFINE
