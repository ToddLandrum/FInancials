*--------------------------------------------------------------------------------------------------------------------------------------------------------
* (ES) AUTOGENERADO - ¡¡ATENCIÓN!! - ¡¡NO PENSADO PARA EJECUTAR!! USAR SOLAMENTE PARA INTEGRAR CAMBIOS Y ALMACENAR CON HERRAMIENTAS SCM!!
* (EN) AUTOGENERATED - ATTENTION!! - NOT INTENDED FOR EXECUTION!! USE ONLY FOR MERGING CHANGES AND STORING WITH SCM TOOLS!!
*--------------------------------------------------------------------------------------------------------------------------------------------------------
*< FOXBIN2PRG: Version="1.19" SourceFile="changereg.scx" /> (Solo para binarios VFP 9 / Only for VFP 9 binaries)
*
*
DEFINE CLASS dataenvironment AS dataenvironment 
 	*< CLASSDATA: Baseclass="dataenvironment" Timestamp="" Scale="" Uniqueid="" ClassIcon="1" />

	AutoOpenTables = .F.
	DataSource = .NULL.
	Height = 200
	Left = 40
	Name = "Dataenvironment"
	Top = 235
	Width = 520

ENDDEFINE

DEFINE CLASS formchangereg AS frmformcustom OF "..\custom\cforms.vcx" 
 	*< CLASSDATA: Baseclass="form" Timestamp="" Scale="" Uniqueid="" />

	*-- OBJECTDATA items order determines ZOrder / El orden de los items OBJECTDATA determina el ZOrder 
	*< OBJECTDATA: ObjPath="Lbllabelcustom1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="txtcRegCode" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="cmdOK" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Cmdcommandbuttoncustom1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Lbllabelcustom2" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="txtClientID" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Lbllabelcustom3" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="txtCompany" UniqueID="" Timestamp="" />

	*<DefinedPropArrayMethod>
		*m: processreg
		*p: cregcode
		*p: csavereg
		*p: oldregcode
		*p: _memberdata		&& XML Metadata for customizable properties
	*</DefinedPropArrayMethod>

	Caption = "Change Registration Code"
	cregcode = 
	csavereg = .F.
	DoCreate = .T.
	Height = 231
	HelpContextID = 53
	Name = "FormChangereg"
	oldregcode = .F.
	Width = 596
	_memberdata = <VFPData>
		<memberdata name="cregcode" display="cRegCode"/>
		</VFPData>		&& XML Metadata for customizable properties
	Mwresize1.lblHighLight.Name = "lblHighLight"
	Mwresize1.lblShading.Name = "lblShading"
	Mwresize1.Name = "Mwresize1"

	ADD OBJECT 'Cmdcommandbuttoncustom1' AS cmdcommandbuttoncustom WITH ;
		Caption = "\<Cancel", ;
		Default = .F., ;
		Height = 36, ;
		Left = 300, ;
		Name = "Cmdcommandbuttoncustom1", ;
		TabIndex = 5, ;
		Top = 180, ;
		Width = 75
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="commandbutton" />

	ADD OBJECT 'cmdOK' AS cmdcommandbuttoncustom WITH ;
		Caption = "\<OK", ;
		Default = .F., ;
		Height = 36, ;
		Left = 204, ;
		Name = "cmdOK", ;
		TabIndex = 4, ;
		Top = 180, ;
		Width = 75
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="commandbutton" />

	ADD OBJECT 'Lbllabelcustom1' AS lbllabelcustom WITH ;
		Caption = "Registration Code", ;
		Left = 24, ;
		Name = "Lbllabelcustom1", ;
		Top = 120
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="label" />

	ADD OBJECT 'Lbllabelcustom2' AS lbllabelcustom WITH ;
		Caption = "Client ID", ;
		Left = 23, ;
		Name = "Lbllabelcustom2", ;
		TabIndex = 6, ;
		Top = 42
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="label" />

	ADD OBJECT 'Lbllabelcustom3' AS lbllabelcustom WITH ;
		Caption = "Registered Company:", ;
		Left = 23, ;
		Name = "Lbllabelcustom3", ;
		TabIndex = 6, ;
		Top = 78
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="label" />

	ADD OBJECT 'txtClientID' AS txttextboxcustom WITH ;
		ControlSource = "m.goApp.cClient", ;
		Height = 20, ;
		Left = 131, ;
		Name = "txtClientID", ;
		TabIndex = 2, ;
		Top = 40, ;
		Width = 61
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="textbox" />

	ADD OBJECT 'txtCompany' AS txttextboxcustom WITH ;
		ControlSource = "m.goApp.cRegCompany", ;
		Height = 20, ;
		Left = 131, ;
		Name = "txtCompany", ;
		TabIndex = 3, ;
		Top = 76, ;
		Width = 361
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="textbox" />

	ADD OBJECT 'txtcRegCode' AS txttextboxcustom WITH ;
		ControlSource = "THISFORM.cRegCode", ;
		Height = 20, ;
		Left = 132, ;
		Name = "txtcRegCode", ;
		TabIndex = 3, ;
		Top = 118, ;
		Width = 360
		*< END OBJECT: ClassLib="..\custom\ccontrol.vcx" BaseClass="textbox" />
	
	PROCEDURE beforeclose
		LPARAMETERS nCloseReason
		
		IF nCloseReason = 1
		   this.cancelallchanges()
		ELSE
		   DODEFAULT(nclosereason)
		ENDIF       
	ENDPROC

	PROCEDURE cancelallchanges
		m.goapp.cregcode = thisform.oldregcode
		DODEFAULT()
	ENDPROC

	PROCEDURE Init
		IF DODEFAULT()
		   m.goApp.ConfigReg(.T.)
		   this.txtClientID.Refresh()
		   this.txtcregCode.Refresh()
		   this.txtcOMPANY.Refresh()
		   this.csavereg = m.goapp.ccode + m.goapp.cstates
		   thisform.cRegCode = ALLTRIM(m.goapp.ccode) 
		ENDIF    
		
	ENDPROC

	PROCEDURE processreg
		LOCAL lcRegCode, lnX, lcClient, lnClient, lnCode, oReg, llSuccess
		
		IF EMPTY(m.goApp.cRegCompany)
		   MESSAGEBOX('Registered Company cannot be blank. Please enter the name of the company the software is registered under.',0,'Registration Error')
		   RETURN
		ENDIF
		
		IF EMPTY(m.goApp.cClient)
		   MESSAGEBOX('Company Client ID cannot be blank. Please enter the client ID # of the company the software is registered under.',0,'Registration Error')
		   RETURN
		ENDIF
		
		IF EMPTY(thisform.cRegCode)
		   MESSAGEBOX('The registration code cannot be blank. Please enter the registration code provided by SherWare.',0,'Registration Error')
		   RETURN
		ENDIF
		
		oReg = CREATEOBJECT('swregcode')
		
		lnX = 0
		
		lcClient  = m.goApp.cClient
		lcCompany = m.goApp.cRegCompany
		lcRegCode = STRTRAN(thisform.cRegCode,'-','')
		lcRegCode = STRTRAN(lcRegCode,'.','')
		lcRegCode = STRTRAN(lcRegCode,'&','')
		lcRegCode = STRTRAN(lcRegCode,'_','')
		lcRegCode = STRTRAN(lcRegCode,' ','')
		lcRegCode = STRTRAN(lcRegCode,'#','')
		lcRegCode = STRTRAN(lcRegCode,'@','')
		lcRegCode = STRTRAN(lcRegCode,'^','')
		lcRegCode = STRTRAN(lcRegCode,'=','')
		lcRegCode = STRTRAN(lcRegCode,'/','')
		lcRegCode = lcRegCode + SPACE(10)
		lnClient  = INT(VAL(lcClient))
		
		llSuccess = oReg.WriteCode(lnClient,lcRegCode, lcCompany)
		
		
		IF FILE(m.goapp.cCommonFolder+'swconfig.daa',1)
		   * Check for tampered system date
		   IF oReg.GetOpt(5)
		      * only do this for live version
		      lnClient = oReg.GetCode(1)
		      lcCode   = oReg.GetCode(2)
		      * Get the support expiration date
		      ldExpDate = oReg.Checksum(lnClient, lcCode, .F., .T.)
		      fh = FOPEN('datafiles\swconfig.daa')
		      ldCurrentDate = FGETS(fh)
		      FCLOSE(fh)
		      ldCurrentDate = GOMONTH(CTOD(ldCurrentDate),-14)
		      IF ldExpDate >= ldCurrentDate
		         * the expiration date is good now. delete the tampered flag file
		         ERASE (m.goapp.cCommonFolder+'swconfig.daa')
		      ENDIF
		   ENDIF
		ENDIF
		
		IF NOT llSuccess
		   MESSAGEBOX('Unable to write to the registration code file.',0,'Registration Error')
		ELSE
		   m.goApp.ConfigReg()
		ENDIF
		
		oReg = NULL
		RELEASE oReg
		
		THISFORM.RELEASE()
		
		
	ENDPROC

	PROCEDURE Cmdcommandbuttoncustom1.Click
		thisform.cancelallchanges()
		thisform.release()
	ENDPROC

	PROCEDURE cmdOK.Click
		thisform.processreg()
	ENDPROC

	PROCEDURE txtClientID.When
		thisform.oldregcode = this.Value
		DODEFAULT()
	ENDPROC

	PROCEDURE txtCompany.When
		thisform.oldregcode = this.Value
		DODEFAULT()
	ENDPROC

	PROCEDURE txtcRegCode.When
		thisform.oldregcode = this.Value
		DODEFAULT()
	ENDPROC

ENDDEFINE
