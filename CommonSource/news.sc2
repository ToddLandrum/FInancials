*--------------------------------------------------------------------------------------------------------------------------------------------------------
* (ES) AUTOGENERADO - ¡¡ATENCIÓN!! - ¡¡NO PENSADO PARA EJECUTAR!! USAR SOLAMENTE PARA INTEGRAR CAMBIOS Y ALMACENAR CON HERRAMIENTAS SCM!!
* (EN) AUTOGENERATED - ATTENTION!! - NOT INTENDED FOR EXECUTION!! USE ONLY FOR MERGING CHANGES AND STORING WITH SCM TOOLS!!
*--------------------------------------------------------------------------------------------------------------------------------------------------------
*< FOXBIN2PRG: Version="1.19" SourceFile="news.scx" /> (Solo para binarios VFP 9 / Only for VFP 9 binaries)
*
*
DEFINE CLASS dataenvironment AS dataenvironment 
 	*< CLASSDATA: Baseclass="dataenvironment" Timestamp="" Scale="" Uniqueid="" ClassIcon="1" />

	DataSource = .NULL.
	Height = 0
	Left = 0
	Name = "Dataenvironment"
	Top = 0
	Width = 0

ENDDEFINE

DEFINE CLASS formnews AS form 
 	*< CLASSDATA: Baseclass="form" Timestamp="" Scale="" Uniqueid="" />

	*-- OBJECTDATA items order determines ZOrder / El orden de los items OBJECTDATA determina el ZOrder 
	*< OBJECTDATA: ObjPath="oBrowser" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="cmdOK" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Mwresize1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="chkShowNews" UniqueID="" Timestamp="" />

	*<DefinedPropArrayMethod>
		*m: getnews
		*p: lfrommenu
		*p: newsfilename
		*p: newsurl
		*p: _memberdata		&& XML Metadata for customizable properties
	*</DefinedPropArrayMethod>

	AutoCenter = .T.
	Caption = "SherWare News"
	DoCreate = .T.
	Height = 608
	lfrommenu = .F.
	Name = "FormNews"
	newsfilename = .F.
	newsurl = 
	TitleBar = 0
	Visible = .T.
	Width = 864
	WindowState = 0
	_memberdata = <VFPData>
		<memberdata name="newsfilename" display="NewsFileName"/>
		<memberdata name="newsurl" display="NewsURL"/>
		<memberdata name="getnews" display="GetNews"/>
		<memberdata name="lfrommenu" display="lFromMenu"/>
		</VFPData>		&& XML Metadata for customizable properties

	ADD OBJECT 'chkShowNews' AS checkbox WITH ;
		Alignment = 0, ;
		AutoSize = .T., ;
		Caption = "Don't show this news again", ;
		Height = 17, ;
		Left = 7, ;
		Name = "chkShowNews", ;
		Top = 587, ;
		Value = .F., ;
		Width = 169
		*< END OBJECT: BaseClass="checkbox" />

	ADD OBJECT 'cmdOK' AS commandbutton WITH ;
		Cancel = .T., ;
		Caption = "OK", ;
		Default = .T., ;
		Height = 27, ;
		Left = 390, ;
		Name = "cmdOK", ;
		Top = 571, ;
		Width = 84
		*< END OBJECT: BaseClass="commandbutton" />

	ADD OBJECT 'Mwresize1' AS mwresize WITH ;
		Left = 660, ;
		Name = "Mwresize1", ;
		Top = 556, ;
		lblHighLight.Name = "lblHighLight", ;
		lblShading.Name = "lblShading"
		*< END OBJECT: ClassLib="..\custom\mwresize.vcx" BaseClass="control" />

	ADD OBJECT 'oBrowser' AS olecontrol WITH ;
		Height = 562, ;
		Left = 2, ;
		Name = "oBrowser", ;
		Top = 0, ;
		Width = 861
		*< END OBJECT: BaseClass="olecontrol" OLEObject="c:\windows\syswow64\ieframe.dll" Value="0M8R4KGxGuEAAAAAAAAAAAAAAAAAAAAAPgADAP7/CQAGAAAAAAAAAAAAAAABAAAAAQAAAAAAAAAAEAAAAgAAAAEAAAD+////AAAAAAAAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9/////v////7////+/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////1IAbwBvAHQAIABFAG4AdAByAHkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWAAUA//////////8BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKAFKFxvENcBAwAAAEABAAAAAAAAAwBPAGwAZQBPAGIAagBlAGMAdABEAGEAdABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB4AAgEDAAAAAgAAAP////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAArAAAAAAAAAADAEEAYwBjAGUAcwBzAE8AYgBqAFMAaQB0AGUARABhAHQAYQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJgACAP///////////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAA4AAAAAAAAAAMAQwBoAGEAbgBnAGUAZABQAHIAbwBwAHMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAIA////////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAQAAAAAAAAAAwAAAP7////+////BAAAAP7///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9h+VaICjTQEalrAMBP1wWiTAAAAP1YAAAWOgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAATAAAAAAAAAAAAAAAOAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAA4NBXAHM1zxGuaQgAKy4SYggAAAAAAAAATAAAAAEUAgAAAAAAwAAAAAAAAEaAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" />
	
	PROCEDURE getnews
		LOCAL llReturn, lcNewsFile, lcOldNewsFile, lcNewsURL
		LOCAL lcClient
		
		llReturn = .T.
		
		TRY
		   DECLARE INTEGER URLDownloadToFile IN urlmon.DLL;
		      INTEGER pCaller, ;
		      STRING  szURL, ;
		      STRING  szFileName, ;
		      INTEGER dwReserved, ;
		      INTEGER lpfnCB
		
		   llReturn   = .T.
		   lcClient   = m.goapp.cclient
		   lcNewsFile = ADDBS(SYS(2023)) + SYS(2015) + ".txt" && temporary file created locally so server version can be read
		   lcNewsURL  = "http://support.sherware.com/news/news-" + ALLTRIM(lcClient) + ".html?fakevariable=" + SYS(2015)
		   lcOldNewsFile = specialfolders('AppData')+"SherWare\oldnews.txt"
		
		   URLDownloadToFile(0, lcNewsURL, lcNewsFile, 0, 0)
		   IF FILE(lcNewsFile)
		      THISFORM.NewsURL = lcNewsURL
		      llReturn         = .T.
		   ELSE
		      lcNewsURL = "http://support.sherware.com/news/news-" + ALLTRIM(m.goapp.cProductName) + ".html?fakevariable=" + SYS(2015)
		      URLDownloadToFile(0, lcNewsURL, lcNewsFile, 0, 0)
		      IF FILE(lcNewsFile)
		         THISFORM.NewsURL = lcNewsURL
		         llReturn         = .T.
		      ELSE
		         lcNewsURL = "http://support.sherware.com/news/news.html?fakevariable=" + SYS(2015)
		         URLDownloadToFile(0, lcNewsURL, lcNewsFile, 0, 0)
		         IF FILE(lcNewsFile)
		            THISFORM.NewsURL = lcNewsURL
		            llReturn         = .T.
		         ELSE
		            llReturn = .F.
		         ENDIF
		      ENDIF
		   ENDIF
		
		   * Check to see if we have an old news file
		   * If we do, compare it to the current news
		   * and don't show the current if it's the same
		   * as the old.
		   IF FILE(lcOldNewsFile) AND FILE(lcNewsFile) AND NOT THISFORM.lFromMenu
		      lcOldNews = FILETOSTR(lcOldNewsFile)
		      lcNewNews = FILETOSTR(lcNewsFile)
		      IF lcOldNews == lcNewNews
		         llReturn = .F.
		      ENDIF
		   ENDIF
		
		   THISFORM.NewsFileName = lcNewsFile
		
		CATCH
		   llReturn = .F.
		ENDTRY
		
		RETURN llReturn
		
		
		
	ENDPROC

	PROCEDURE Init
		LPARAMETERS tlFromMenu
		
		THISFORM.lFromMenu = tlFromMenu
		
		IF NOT tlFromMenu AND FILE(m.goapp.ccommonfolder+'nonews.txt')
		   thisform.Release()
		   RETURN .f.
		ENDIF 
		lnHeight = SYSMETRIC(2)
		lnWidth  = SYSMETRIC(1)
		
		IF lnHeight = 600
		   THISFORM.HEIGHT = (lnHeight * .75) && * .50
		   THISFORM.WIDTH  = lnWidth  * .75
		ELSE
		   THISFORM.HEIGHT = (lnHeight * .50) && * .70
		   THISFORM.WIDTH  = lnWidth  * .50
		ENDIF
		THISFORM.RESIZE()
		thisform.AutoCenter = .t.
		
		IF THISFORM.GetNews()
		   THISFORM.obrowser.NAVIGATE(THISFORM.NewsURL)
		   thisform.cmdok.SetFocus()
		ELSE
		   RETURN .F.
		   thisform.Release()
		ENDIF
		
	ENDPROC

	PROCEDURE Resize
		IF DODEFAULT()
		   m.This.mwResize1.Resize( m.This )
		ENDIF 
	ENDPROC

	PROCEDURE chkShowNews.Click
		IF this.Value = .t.
		* Save the current news to the old news file so we can compare later
		   lcOldNews = FILETOSTR(thisform.NewsFileName)
		* Store in an Appdata folder for this user to it only applies to this user
		   lcSherWareFolder = ADDBS(specialfolders('AppData'))+"SherWare"
		   IF NOT DIRECTORY(lcSherWareFolder)
		      MD (lcSherWareFolder)
		   ENDIF    
		   lcOldNewsFile = lcSherWareFolder+"\oldnews.txt"
		   STRTOFILE(lcOldNews,lcOldNewsFile)
		ENDIF 
	ENDPROC

	PROCEDURE cmdOK.Click
		thisform.Release()
	ENDPROC

	PROCEDURE oBrowser.BeforeNavigate2
		*** ActiveX Control Event ***
		LPARAMETERS pdisp, lcurl, FLAGS, targetframename, postdata, headers, CANCEL
		LOCAL lnPK, lcCommand
		
		IF LEFT(UPPER(lcUrl), 7) = "VFPS://"
		    lcCommand = UPPER(STREXTRACT(lcUrl, "//", "/"))
		    IF lcCommand = "FORCEUPDATE"
		        TRY
		            IF NOT FILE('datafiles\forceupd.cfg')
		                fh = FCREATE('datafiles\forceupd.cfg')
		                IF fh > 0
		                    MESSAGEBOX('The software will now shut down. Start it up again to download an update.', 64, 'Force Update')
		                    QUIT 
		                ELSE
		                    MESSAGEBOX('Could not create the temp file to force the update. Please try again later.', 64, 'Force Update')
		                ENDIF
		            ENDIF
		        CATCH
		        ENDTRY
		        CANCEL = .T.  && don't want to actually show lcUrl
		    ENDIF
		ENDIF
	ENDPROC

ENDDEFINE
